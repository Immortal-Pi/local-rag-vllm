<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>RAG Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root { --gap: 12px; --bg:#f6f7f9; --card:#fff; --border:#e8e8e8; --text:#111; --muted:#6b7280; --accent:#2d6cdf; }
      * { box-sizing:border-box }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
      header { position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border); padding:12px 16px; z-index:2; display:flex; align-items:center; gap:12px; }
      header h1 { font-size:16px; margin:0; font-weight:600; }
      /* header button { margin-left:auto; padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer } */
      header button { padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer }
      header .spacer { margin-left:auto; }
      main { display:flex; flex-direction:column; height:calc(100vh - 56px); }
      #thread { flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:14px; }
      .msg { max-width:960px; width:100%; margin:0 auto; }
      .bubble { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; width:100%; }
      .user .bubble { border-color:#c5d4fb; background:#eaf0ff; }
      .meta { font-size:12px; color:var(--muted); margin-bottom:6px; }
      details { background:#fafafa; border:1px solid var(--border); border-radius:8px; padding:8px 10px; margin-top:10px; }
      details summary { cursor:pointer; font-weight:600; }
      pre { white-space:pre-wrap; word-break:break-word; margin:8px 0 0 0; }
      .toolbar { display:flex; gap:8px; margin:8px 0; }
      .pill { font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); }
      #composer { border-top:1px solid var(--border); background:var(--card); padding:10px 12px; display:flex; gap:10px; align-items:center; }
      #q { flex:1; min-height:44px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; }
      #send { background:var(--accent); color:#fff; border:0; border-radius:10px; padding:10px 14px; cursor:pointer; }
      #send:disabled { opacity:.6; cursor:default; }
      .spinner { color:var(--muted); font-size:14px; }
      .error { color:#b00020; white-space:pre-wrap; }
      .answer { font-size:15px; line-height:1.5; }
    </style>
  </head>

  <body>
    <header>
      <h1>RAG Chat</h1>

      <span class="spacer"></span>

      <input id="fileInput" type="file" accept=".pdf,.txt,.md" style="display:none" />
      <button id="uploadBtn" title="Upload document">＋ Upload</button>
      <button id="newchat">New chat</button>
    </header>

    <main>
      <div id="thread"></div>

      <div id="composer">
        <input id="q" type="text" placeholder="Ask something…"
               value="What is physical resource layer?" />
        <label style="display:flex;align-items:center;gap:6px">
          <!-- <input id="want_viz" type="checkbox" /> Viz -->
        </label>
        <button id="send">Send</button>
      </div>
    </main>

    <script>
      // If serving the UI from FastAPI (/ui), same-origin is best:
      const API = "/ask";

      const thread  = document.getElementById("thread");
      const qEl     = document.getElementById("q");
    //  const vizEl   = document.getElementById("want_viz");

    // upload logic 
    const uploadBtn = document.getElementById("uploadBtn");
const fileInput = document.getElementById("fileInput");

uploadBtn.addEventListener("click", () => {
  fileInput.click();
});

fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  addSystemMessage(`Uploading "${file.name}"…`);

  try {
    const res = await fetch("/ingest/upload", {
      method: "POST",
      body: formData,
    });

    if (!res.ok) {
      throw new Error(`Upload failed: ${await res.text()}`);
    }

    const data = await res.json();
    addSystemMessage(
      `✅ Indexed "${data.filename}" (${data.chunks_indexed} chunks)`
    );
  } catch (err) {
    addSystemMessage(`❌ Upload error: ${err}`);
  } finally {
    fileInput.value = "";
  }
});

function addSystemMessage(text) {
  const wrap = document.createElement("div");
  wrap.className = "msg assistant";
  wrap.innerHTML = `
    <div class="bubble">
      <div class="meta">System</div>
      <div>${escapeHtml(text)}</div>
    </div>`;
  thread.appendChild(wrap);
  scrollToBottom();
}


    // upload logic 

      const sendBtn = document.getElementById("send");

      function scrollToBottom(){ thread.scrollTop = thread.scrollHeight; }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

      function addUserMessage(text){
        const wrap = document.createElement("div");
        wrap.className = "msg user";
        wrap.innerHTML = `
          <div class="bubble">
            <div class="meta">You</div>
            <div>${escapeHtml(text)}</div>
          </div>`;
        thread.appendChild(wrap); scrollToBottom();
      }

      function addAssistantPlaceholder(){
        const wrap = document.createElement("div");
        wrap.className = "msg assistant";
        wrap.innerHTML = `
          <div class="bubble">
            <div class="meta">Assistant</div>
            <div class="spinner">Thinking…</div>
          </div>`;
        thread.appendChild(wrap); scrollToBottom();
        return wrap;
      }

      function renderAssistantMessage(container, data){
        const bubble = container.querySelector(".bubble");
        const error = data?.error;
        const answer = data?.answer ?? "";
        const sources = data?.sources ?? [];

        if (error) {
          bubble.innerHTML = `
            <div class="meta">Assistant</div>
            <div class="error">${escapeHtml(error)}</div>
          `;
          scrollToBottom();
          return;
        }

        const sourcesPretty = sources.length ? JSON.stringify(sources, null, 2) : "";

        bubble.innerHTML = `
          <div class="meta">Assistant</div>

          <div class="toolbar">
            <span class="pill">${sources.length} source(s)</span>
          </div>

          <div class="answer">${escapeHtml(answer)}</div>

          ${sources.length ? `
            <details>
              <summary>Sources</summary>
              <pre>${escapeHtml(sourcesPretty)}</pre>
            </details>
          ` : ``}
        `;

        scrollToBottom();
      }

      async function sendMessage(){
        const text = qEl.value.trim();
        if (!text) return;

        addUserMessage(text);
        qEl.value = "";
        qEl.focus();

        const placeholder = addAssistantPlaceholder();

        try {
          const res = await fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question: text,
            //   want_viz: vizEl.checked,
              filters: null,
              k: 5
            })
          });

          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          renderAssistantMessage(placeholder, data);
        } catch (err) {
          renderAssistantMessage(placeholder, { error: String(err) });
        }
      }

      document.getElementById("send").addEventListener("click", sendMessage);
      qEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      document.getElementById("newchat").addEventListener("click", () => {
        thread.innerHTML = "";
        qEl.value = "";
        qEl.focus();
      });

      // Optional: auto-run once
      // sendMessage();
    </script>
  </body>
</html>
